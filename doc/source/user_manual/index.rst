用户手册
#####################

本章主要对基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统的所有功能及功能的操作进行介绍。

软件概览
**********************

软件介绍
++++++++++++++++++

本软件为一种基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统，能够实现土石混合体CT图像的自动三维重建功能，利用本发明可科学地、有效地获得土石混合体的真实三维结构信息，并建立土石混合体的三维模型，极大节省了人力财力，使得在此基础上展开的数值试验研究更加合理与准确，为土石混合体中力学性质研究与工程应用提供了支持。

基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统的系统结构示意图如下：

.. figure::  /user_manual/pic/modules_image.jpg
   :width: 80%
   :align: center

   基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统的系统结构示意图

优点
++++++++++++++++++
1. 提出一种快速有效且精细地对土石混合体CT图像进行分割的方法，充分利用深度学习的机制，充分学习图像的上下文信息，更加关注于提高目标边界的分割精度，获得较高的砾石边界分割准确率。这种快速有效且精细地对土石混合体CT图像进行分割的方法，同样适用于其他利用CT扫描的医学图像，具有通用性。

2. 设计的砾石边界重组算法对于土石混合体CT图像中砾石重组准确，鲁棒性好，进而提高了三维重建的效果。

背景技术
++++++++++++++++++

土石混合体由作为骨料的砾石与作为填充料的粘土或砂土组成，是一种广泛存在于自然界的地质体。土石混合体细观结构特性及物理力学特性的深入研究是当今工程建设的需要,也是岩土力学发展的必然。由于土石混合体内部砾石的存在，使得其物理力学性质很难通过传统的室内或野外试验获取，所以数值试验广泛应用于土石混合体物理力学性质的研究。然而在数值试验研究时,建立合理的土石混合体细观结构模型至关重要。

基于CT扫描获得的土石混合体二维图像进行土石混合体三维细观结构重建，可借助计算机检测技术处理CT图像，可以获得较精确的结构参数信息。目前CT图像的传统分割算法有阈值分割法、区域生长分割方法等，但是由于土石混合体中存在砾石边界粘结的存在，使得图像分割传统方法对于CT扫描的土石混合体图像分割的准确率降低，并且缺乏准确的砾石重组分类算法，将导致图像中粘连的砾石可能被识别成相同砾石，降低三维重建效果。因此建立一种科学准确的土石混合体的CT扫描图像分割及三维重建方案对于土石混合体力学性质研究与工程应用具有重要的意义。

运行硬件环境
++++++++++++++++++

建议要求：
      - 处理器：Inter Core 2 Duo或更高级别处理器
      - 内存：2GB RAM
      - 硬盘：1GB 空闲硬盘空间
      - 显卡：支持1024x768及以上分辨率的高彩色显示适配器

运行软件环境
++++++++++++++++++

建议要求：
      - Windows 10 版本操作系统

编程语言及其版本
++++++++++++++++++

编程语言：Python 3.7.9

软件界面
****************

软件下载并且安装好后，当您双击基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统图标后，将出现主界面，如下图所示：

.. figure::  /user_manual/pic/MainWindow.png
   :width: 90%
   :align: center

   软件界面

- 工具栏：常用功能的集合，点击后快速实现特定功能。快速实现导入砾石CT切片、选择神经网络模型、载人模型权重、选择是否使用GPU加速、分割砾石、导入分割后图片、清空窗口、上一张、下一张、重置当前、选择画笔粗细、选择画笔颜色、保存全部图片、三维重建等功能。
- 图像显示窗口：用于将原始图像与经过分割后的图像显示在软件界面上，以及通过区域修补工具对风格图像进行精细化的添加与擦除。
- 三维重建窗口：用于将土石混合体CT图像进行边界提取与重组，进而渲染出三维模型，实现三维重建。

数据导入模块
****************

提供数据导入功能。

图像导入
++++++++

单击【导入砾石CT切片】按钮，如图所示，进入【选择文件夹】界面。找到需分割图像存放的文件夹，单击【选择文件夹】，图像将会显示在图像显示窗口。

.. figure::  /user_manual/pic/import_pre.png
   :width: 40%
   :align: center

   导入砾石CT切片

单击【导入分割后图片】按钮，如图所示，进入【选择文件夹】界面。找到分割后图像存放的文件夹，单击【选择文件夹】，图像将会显示在图像显示窗口。

.. figure::  /user_manual/pic/import_seged.png
   :width: 40%
   :align: center

   导入分割后图片

权重导入
++++++++

单击【载入模型权重】按钮，如图所示，进入【选择文件】界面。找到改进Unet全卷积神经网络模型的训练权重文件，单击【选择文件】。

导入神经网络的模型权重，以供神经网络加载模型权重进行图像的预测。

.. figure::  /user_manual/pic/load_weight.png
   :width: 40%
   :align: center

   载入模型权重

图像分割模块
****************

图像分割模块用于神经网络的加载，将CT扫描的土石混合体切面图像序列进行图像预处理，再将图像预处理后的序列图像依次输入改进改进Unet全卷积神经网络中进行预测。

具体地，基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统构建如下图所示的改进UNet改进Unet全卷积神经网络模型。

- 第一部分是编码器部分，改进UNet改进Unet全卷积神经网络的编码器部分使用VGG网络的结构，为卷积层和最大池化的堆叠。利用编码器部分我们可以获得五个初步有效特征层，在第二部分中，我们会利用这五个有效特征层可以进行特征融合。

- 第二部分是解码器部分，上采样部分进行4次上采样，即双线性插值算法，使得到的高级语义特征层恢复到原图像的分辨率，也使得分割图恢复边缘等信息更加精细。在改进UNet神经网络中使用了skip connection结构，即每上采样一次，就与编码器部分对应的通道数相同尺度的有效特征层进行融合。skip connection结构起到了补充信息的作用，在高层补充了语义的信息，在底层细化了分割的轮廓。最终获得一个融合了所有特征的有效特征层。

- 第三部分是预测部分，使用一个卷积层对上采样部分获得的有效特征层中每一个特征点进行分类，相当于对每一个像素点进行分类。

.. figure::  /user_manual/pic/unet.png
   :width: 100%
   :align: center

   改进UNet改进Unet全卷积神经网络结构示意图

使用GPU加速
+++++++++++++

如下图所示，可选择是否使用GPU加速，使用GPU加速模型对序列CT图像的预测过程。

.. figure::  /user_manual/pic/is_gpu.png
   :width: 40%
   :align: center

   可选择是否使用GPU加速

分割砾石
++++++++++++++

单击【分割砾石】按钮，将使用改进Unet全卷积神经网络进行图像的分割。

.. figure::  /user_manual/pic/seg_imgs.png
   :width: 40%
   :align: center

   分割砾石

数据修改模块
****************

所述数据修改模块用于原始图像与分割图像的对比展示，以及对图像目标区域进行精细化修补。所示数据修改模块包括图像浏览子模块与区域添加与擦除子模块。

图像浏览子模块
++++++++++++++++++++

图像浏览子模块用于将输入的原始图像与经过神经网络分割的图像展示再应用程序的用户界面中，便于对分割结果做出主观评估与进一步地完善,如下图所示。

.. figure::  /user_manual/pic/image_display.png
   :width: 70%
   :align: center

   图像浏览子模块

单击【上一张】或【下一张】按钮即可绘制上一张或者下一张图片。

.. figure::  /user_manual/pic/pre_or_next_imgs.png
   :width: 40%
   :align: center

   上一张、下一张

单击【清空窗口】按钮即可清除当前导入的所有图像。

.. figure::  /user_manual/pic/clean_window.png
   :width: 40%
   :align: center

   清空窗口

区域添加与擦出子模块
++++++++++++++++++++

区域添加与擦除子模块用于对分割图像目标区域的精细化修补。对于错误分割产生的多余区域可使用橡皮擦工具进行擦除；对于被错误识别为背景的砾石区域，可使用画笔工具进行适当地添加内容。

如下图所示，点击【画笔粗细】选择框，可以根据实际情况调整画笔的粗细，单位为像素点。默认画笔粗细为2；点击【画笔颜色】选择框，选择画笔的颜色，黑色为背景，白色为目标，默认为黑色。

.. figure::  /user_manual/pic/palette.png
   :width: 40%
   :align: center

   区域添加与擦出子模块

点击【重置当前】按钮，将会撤销当前展示图像的所有更改，恢复原始。

.. figure::  /user_manual/pic/reset.png
   :width: 40%
   :align: center

   重置当前

三维重建模块
****************

所述三维重建模块用于对土石混合体的图像序列中的砾石进行边界提取及边界矩阵的重组，获得每个砾石表面的点云数据并将砾石的数据信息显示再应用程序用户界面中，对分割后图像中每个像素点进行坐标比例变换操作，随后进行砾石表面点云数据的三维可视化。所述三维重建模块包括点云数据处理子模块、可视化子模块、砾石信息展示模块。

.. figure::  /user_manual/pic/3D_window.png
   :width: 70%
   :align: center
   
   三维重建模块

点云数据处理子模块
++++++++++++++++++

点云数据处理子模块利用开源计算机视觉库OpenCV的findContours函数识别出图像中的所有边界与边界矩阵重组，分离出每一个砾石的点云数据。为使重组后的模型尺寸与实际尺寸保持一致，需要对像素点的三维坐标按比例进行转换。

可视化子模块
++++++++++++++++++

所述可视化子模块用于对砾石的数据信息进行可视化。使用免费的、 源代码公开的计算机图形学及三维可视化软件工具包VTK，在应用程序用户界面中渲染出砾石模型，达到三维重建。

如下图，点击【三维重建】，所选中的砾石将会可视化在三维重建窗口中。

.. figure::  /user_manual/pic/3D_restruction.png
   :width: 50%
   :align: center
   
   三维重建选中的砾石

砾石信息展示子模块
++++++++++++++++++

所述砾石信息展示模块用于将每一个砾石的数据信息显示到应用程序用户界面中。

.. figure::  /user_manual/pic/rocks_information.png
   :width: 30%
   :align: center
   
   三维重建模块

在信息框中可选择需要查看的砾石，渲染在窗口中。如下图，点击【全选】，将选中全部砾石；点击【全不选】，将全部砾石设置为未选状态。

.. figure::  /user_manual/pic/all_select_or_noselect.png
   :width: 30%
   :align: center
   
   全选-全不选

数据导出模块
************

在三维重建界面中，点击【输出txt文件】，会将砾石表面点云数据导出至.txt格式文件中；点击【输出VTK文件】，会将砾石表面点云数据导出至通用数据格式.vtk,用于其他可视化软件（如ParaView）和数值模拟软件。


.. figure::  /user_manual/pic/output_txt_vtk.png
   :width: 30%
   :align: center
   
   数据导出模块

使用流程概述
************

1. 点击【导入砾石CT切片】，选择图像集存放的文件夹，点击确认。
2. 选择神经网络模型，UNet或者UNet++。默认为UNet。
3. 点击【载入模型权重】，选择预训练的.pth格式权重文件，点击确认。权重文件路径将会显示在【载入模型权重】按钮下方。
4. 根据本地计算机配置情况，选择是否勾选【使用GPU加速】。默认为不使用GPU加速。
5. 点击【分割砾石】，进入图像分割进程，根据配置情况不同，可能会是一个较为耗时的操作。
6. 点击【上一张】或【下一张】，浏览分割结果图，左侧为原始图像，右侧为使用神经网络分割后的图像。当前图像的id会显示在工具栏的上方。
7. 点击【清空窗口】会清除所有导入的文件。
8. 可使用鼠标在图像浏览区进行精细化修补，在工具栏【画笔粗细】调整画笔的粗细，默认为2；在【画笔颜色】中选择画笔的颜色，默认为黑色。点击【重置当前】，将撤销当前图像的所有作出的更改。
9. 点击【保存全部图片】，选择图像保存的文件夹，点击确认。
10. 点击【三维重建】，进入三维重建子窗口。勾选需要查看的砾石，再点击【三维重建】，进行重新可视化。
11. 点击【输出txt文件】或【输出vtk文件】，将砾石表面点云数据导出为选定格式的文件，用于其他的软件中。

使用实例
**********

利用岩土 CT 扫描设备对土石混合体试样（f100 mm×120 mm）进行扫描，得到土石混合体的横切面图像，将其导出为 BMP 格式图像（像素512× 512），得到序列CT图像集，如下图所示：

.. figure::  /user_manual/pic/rock.png
   :width: 50%
   :align: center
   
   使用CT扫描得到的土石混合体切面图像


将图像导入基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统，得到的结果如下：

.. figure::  /user_manual/pic/image_display.png
   :width: 100%
   :align: center
   
   使用改进Unet全卷积神经网络分割得到的结果图像

使用基于改进Unet全卷积神经网络的土石混合体CT图像三维重建系统进行三维重建和渲染，如下图所示：

.. figure::  /user_manual/pic/3D_window.png
   :width: 100%
   :align: center
   
   使用改进Unet全卷积神经网络分割得到的结果图像



